
그러면 우리가 이번 시간에 우리가 최종적으로 이번 강좌를 통해서 만들게된 프로젝트를 간단하게 살펴보는 시간을 갖도록 하겠습니다. 
이 사이트는 지금 사용자 사용자 기능과 관리자 시스템의 영역으로 두 가지 영역으로 구성이 되어 있고요.

############# 보안 정책 설정 #############

1. 자원 및 권한 설정
    마이페이지
	    자원 설정 - /mypage
		권한 매핑 - ROLE_USER
	메시지
		자원 설정 - /message
		권한 매핑 - ROLE_MANAGER
	환경설정
		자원 설정 - /config
		권한 매핑 - ROLE_ADMIN
	관리자
		자원 설정 - /admin/**
		권한 매핑 - ROLE_ADMIN
		
2. 사용자 등록 및 권한 부여

3. 권한계층적용
	ROLE_ADMIN > ROLE_MANAGER > ROLE_USER
	
4. 메소드 보안 설정
	메소드 보안 - 서비스 계층 메소드 접근 제어
		io.security.corespringsecurity.aopsecurity.AopMethodService.methodSecured
	
	포인트컷 보안 - 포인트컷 표현식에 따른 메소드 접근 제어
		execution(public * io.security.corespringsecurity.aopsecurity.*Service.pointcut*(..))
		
5. IP 제한하기

보시면 로그인할 수 있는 인증 처리 시스템 그리고 회원을 회원으로 등록할 수 있도록 그렇게 구성이 되어 있습니다.

그러면 보안 정책을 설정해서 자원과 권한을 설정하고 사용자를 등록하고 사용자마다 권한을 부여하도록 하겠습니다. 
그리고 권한 계층도 적용해보고요. 그리고 메서드 보안도 등록을 해서 해당 메소드 보안을 테스트해보도록 하죠.

그리고 우리 사이트에 ip 제한을 두어서 해당 ip에 그 정보와 일치하는 일치하는 클라이언트만 우리 서버에 접속하도록 그렇게 해도 테스트를 해보도록 하겠습니다. 
그럼 먼저 어드민 관리자로 로그인해서 관리자 시스템에 접속하도록 하겠습니다. 
그러면 여기 관리자 메뉴가 보이고요

현재 관리자는 사용자 권한 리소스 권한 계층 그다음에 ip 관리 이렇게 5개의 메뉴 5가지 기능을 가지고 있습니다. 
사용자 기능은 사용자 관리는 지금 어드민 계정 하나가 생성이 돼 있고요 그래서 어드민은 롤 어드민 권한이 부여가 돼 있습니다.

권한 관리는 롤 어드민, 롤 매니저, 롤 유저 이렇게 3개 세 가지 권한을 등록을 했고요. 현재 리소스 자원 관리는 특별한 지금 리소스를 등록을 안 했습니다.
권한 계층 관리도 마찬가지고요. ip 관리는 이렇게 하나의 데이터가 지금 등록이 돼 있죠. 그러면 먼저 리소스 관리를 하도록 하겠습니다. 

그래서 지금 보시면 우리가 각각의 메뉴를 클릭할 때 현재는 아무런 권한 심사를 하지 않습니다. 
그래서 지금은 인증을 받지 않은 사용자가 여기에 나와 있는 모든 메뉴에 접근이 다 가능하도록 그렇게 되어 있죠. 

네 그렇게 되어 있습니다. 그래서 현재 현재 자원에 권한을 설정해서 각각의 지금 메뉴에 접근하기 위해서는 최소한 인증을 받아야 되고 그리고 인증을 받은 사용자가 특정한 권한을 가질 때 해당 자원에 집권하도록 그렇게 보안 설정을 하도록 하겠습니다. 

그래서 /mypage /message /config 환경 설정 각각의 자원에 대해서 권한 매핑을 하도록 그렇게 하죠. 일단 
그러면 다시 로그인을 하고요 어드민으로 관리자에 가서 리소스 관리에 들어가서 등록을 하도록 하겠습니다. 
먼저 마이 페이지 마이 페이지 자원은 타입의 url이고 권한은 ROLE_USER죠

이 권한을 가진 사용자가 이 자원에 접근이 가능하도록 그렇게 등록을 할게요. 그 다음에 /messages url 타입이고 /messages는 ROLE_MANAGER 가 가진 권한을 가진 사용자가 접근이 가능하도록 등록하고요. 그리고 /config url 방식의 ROLE_ADMIN 관리자 권한을 가진 사용자가 접근을 하도록 그렇게 등록을 했습니다. 

그리고 /admin/ 경로에는 아무나 접근하면 안 되겠죠. 오직 관리자만 접근이 가능하도록 ROLE_ADMIN 그렇게 등록을 하도록 하겠습니다. 
이렇게 그래서 총 네 가지 자원 설정을 했고요. 리소스 등록을 했고 이 상태에서 제가 로그 아웃하고 다시 홈으로 가서 이제 마이 페이지에 접근하게 되면
지금 마이페이지 자원에 접근되는 게 아니라 인증을 받도록 인증 페이지가 뜨죠. 마이페이지 메시지도 마찬가지고요 그리고 환경 설정도 마찬가지입니다. 
지금은 인증을 받지 않으면 그 자원은 접근이 안 됩니다.

그 이유가 우리가 지금 어드민에서 관리자 쪽에서 리소스 관리에서 그렇게 지금 설정을 했기 때문에 그와 같은 결과가 지금 생기는 겁니다. 
지금 보시는 바와 같이 리소스 관리가 인가 처리죠 각 자원에 해당하는 권한인데 이렇게 매핑된 데이터가 지금 db에 저장돼 있고 그렇기 때문에
현재 이 자원에 접근하기 위해서는 이 권한을 가진 사용자만이 접근할 수 있다고 그렇게 설정했기 때문에 인가 처리가 지금 데이터 베이스와 연동해서 스프링 시큐리티가 처리를 하고 있습니다. 
그럼 우리가 사용자를 등록하죠. 현재 마이 페이지 메시지 환경 설정 각각의 메뉴에 접근할 수 있는 사용자를 등록하도록 하겠습니다.
그러면 회원가입 메뉴 누르고 유저 계정을 만들도록 하죠. 유저 계정을 만들었고 그다음에 매니저 이렇게 해서 지금은 총 3명의 사용자가 있습니다. 
보시면 어드민 계정, 유저, 매니저 이렇게 3명의 사용자가 있고요. 
현재 권한을 보시면 어드민은 ROLE_ADMIN, user은 ROLE_USER, manager은 ROLE_USER 유저입니다. 
그래서 회원을 가입하게 되면 기본적으로 ROLE_USER라는 권한이 부여가 되고요

우리가 매니저는 ROLE_MANAGER 권한을 부여하도록 하겠습니다. 
그래서 각 사용자마다 각각의 권한이 있고요. 그러면 우리가 먼저 유저 계정으로 로그인을 하게 되면, 유저 계정은 ROLE_USER라는 권한을 가지고 있죠.
그래서 마이 페이지에는 접근이 가능합니다. 왜냐하면 마이 페이지는 ROLE_USER으로 지금 권한으로 매핑이 돼 있죠. 메시지는 메시지는 접근이 안 됩니다. 유저 계정은
메시지는 ROLE_MANAGER와 매핑이 돼 있습니다. 
메시지는 그래서 ROLE_MANAGER 권한을 가진 사용자가 접근이 가능한 거고요 환경 설정은 ROLE_ADMIN 자원을 가진 사용자가 접근이 가능하겠죠.

그러면 ROLE_MANAGER로 인증을 하도록 하겠습니다. 그러면 매니저로 인증을 하고 메시지에 접근하면 지금 매니저 사용자는 지금 접근이 가능하죠. 
그런데 매니저도 마이 페이지나 환경 설정은 접근이 안 됩니다. 
그리고 어드민으로 인증을 한 상태에서 환경 설정은 ROLE_ADMIN 권한과 매핑이 돼 있기 때문에 접근이 가능하지만 마이페이지나 메시지는 역시 접근이 안 됩니다. 
그러면 ROLE_ADMIN 가진 권한을 가진 사용자가 지금 어드민인데요. 
이 어드민이 마이페이지나 메시지 여기에 접근이 가능 하려고 하면 사용자 관리 가서 어드민 계정에 ROLE_MANAGER ROLE_USER 권한을 모두 부여를 해야 각각의 자원에 접근이 가능합니다. 
그러면 제가 환경설정은 접근이 가능했고요. 그다음에 메시지 그다음에 마이 페이지는 지금 접근이 안 되는데 우리가 로그아웃 아웃 하고 다시 어드민으로 로그인을 하고 나서 이제 그 자원 접근하면 지금 자원 접근이 가능하죠. 
인증 처리와 그리고 각각의 자원에 접근이 될 수 있도록 처리하는 인가 처리 모두가 스프링 시큐리티에서 데이터 베이스와 연동해서 지금 현재 처리가 되고 있습니다. 
----
그러면 다시 관리자로 가서 우리가 이렇게 ADMIN 계정에 각각의 권한들을 모두 이렇게 부여를 하면 각각의 권한에 매핑된 자원에 접근이 가능하지만, 우리가 예를 들어서 ROLE_ADMIN의 권한만 부여하더라도 ROLE_MANAGER 그리고 ROLE_USER 이 권한과 매핑된 자원의 접근이 가능하도록 그렇게 처리를 해보겠습니다. 

그게 권한 계층 적용입니다. 그래서 ROLE_ADMIN 그다음에 ROLE_MANAGER ROLE_USER 이렇게 그다음에 롤 하이라이키(Hierarchy) 그와 같은 개념으로 구성을 하게 되면 ROLE_ADMIN 권한을 가지고 있는 사용자는 ROLE_MANAGER ROLE_USER 이 권한과 매핑된 자원에도 접근이 가능하게 됩니다. 
그렇게 하려면 제가 다시 서버를 기동을 할 건데요.
자 여기에 제가 네 Role_Hierarchy(하이라이키) 이 기능을 제가 활성화하도록 하겠습니다. 
그럼 제가 다시 서버를 기동했고 제가 다시 ADMIN으로 로그인을 하고요 인증을 하고 관리자에 들어가겠습니다. 
그러면 여기에 권한 계층 관리에 보시면 이렇게 지금 데이터가 저장이 되어서 나오고 있죠. 그래서 지금 보시면 권한 쪽에 각각의 권한 정보가 있고요. 그리고 부모 권한 쪽에 보면 이 권한에 부모 권한 부모 권한을 설정을 했죠. 
현재 ROLE_ADMIN이 가장 레벨이 높은 권한이기 때문에 부모 권한이 없고요. ROLE_MANAGER는 부모가 부모 권한이 ROLE_ADMIN이고 ROLE_USER는 부모 권한이 ROLE_MANAGER입니다. 
그래서 각각의 권한마다 부모가 설정되어 있는데 이렇게 되면 ROLE_ADMIN은 ROLE_MANAGER와 ROLE_USER를 포함하고 있는 가장 높은 레벨의 보안이죠. 그 다음에 ROLE_MANAGER는 ROLE_USER를 포함하고 있습니다. 
이 상태에서 제가 현재 ADMIN에는 ROLE_ADMIN만 지금 권한이 부여가 된 상태고요 매니저는 ROLE_MANAGER만 이렇게 부여가 돼 있죠.
제가 로그아웃 하고 먼저 Manager로 접근을 하겠습니다. 인증을 하겠습니다.
Manager는 메시지에는 ROLE_MANAGER로 매핑이 돼 있기 때문에 접근이 가능한데 아까 우리가 확인할 때 마이 페이지는 접근이 안 됐죠. 그런데 Manager가 ROLE_USER를 지금 포함하고 있죠 Role_Hierarchy(하이라이키) 기능에 의해서 그래서 마이 페이지가 접근이 가능합니다. 
그런데 환경 설정은 역시 가장 높은 ROLE_ADMIN 그 권한과 매핑이 됐기 때문에 접근이 안 되고요. 그러면 ADMIN으로 제가 로그인을 하고 다시 자원에 접근해보겠습니다. 그러면 당연히 환경 설정은 접근이 가능하고요. 그 다음에 메시지 마이 페이지도 접근이 가능합니다. 
접근이 가능한데, 지금은 ADMIN에게 ROLE_MANAGER ROLE_USER를 주지 않고 ROLE_ADMIN만 이렇게 권한을 부여했는데도 ROLE_MANAGER ROLE_USER에 매핑된 자원이 접근이 가능한데 그 이유가 권한 계층을 우리가 이렇게 줬기 때문에 지금 그 접근이 가능하게 됩니다. 
네 그렇게 해서 우리가 권한계층적용 기능도 살펴봤고요.

그리고 ip 제한해 보겠습니다. 지금은 ip가 제대로 등록이 안 돼 있죠 이렇게 등록돼 있는데 현재 제가 제 pc가 지금 서버를 접속하게 되면 ip가 이와 같은 정보로 지금 나오고 있습니다. 그렇기 때문에 현재 ip 관리는 여기에 등록된 여기에 등록된 ip만 접속이 되도록 그렇게 지금 롤의 어떤 기능이 지금 구현이 돼 있습니다.

그러면 이 정보를 바꿨을 때 이 정보를 바꿨을 때 제가 이 서버에 접속할 수 있을지 그렇게 테스트해보도록 하겠습니다. 
그러면 여기서 제가 데이터베이스에서 바로 액세스 아이피 여기를 이렇게 127.0.0.1로 변경을 하고 곧바로 로그인 한 다음에 제가 지금 환경 설정에 접속 하게 되면 접근이 안 되죠. Invalid IpAddress 돼 있습니다. 
어떤 자원에도 지금 접근이 안 됩니다.

그렇죠 대시보드는 대시보드는 아예 우리가 자원에 권한 매핑을 안 했죠. 그래서 권한 매핑이 된 자원에는 접근이 안 되죠. 지금 이미 ip에서 그 클라이언트의 접근 자체를 지금 막았기 때문에 안 되고 있습니다. 매소드 보안은 우리가 권한 설정을 아예 안 했죠. 지금 그래서 접근이 가능한 거고요.
--
그래서 다시 원상태로 서버를 기동해서 보도록 하겠습니다. 그래서 ip 어드레스도 우리가 롤 보트라는 네 ip 보터 오터 클래스를 우리가 추가했기 때문에 지금 그 

처리가 데이터베이스 연동이 돼서 인가 처리가 되고 있습니다. 그러면 이제 우리가 여기 메소드 보안을 살펴보죠 메소드 보안은 이런 거예요. 
가령 현재 클라이언트가 어떤 자원을 요청하게 되면 어떤 자원에 그러면 그 자원에 접속이 된 상태에서 메소드 보안은 해당 서비스의 메소드 이 메소드를 호출해서 이 메소드 하나로 접근이 가능한지 가능하지 않는지 그 인가 처리를 하는 것을 말합니다. 

그러면 현재 이 클래스 AopMethodService 이 서비스 클래스에 methodSecured 이 메소드에 접근이 지금은 되고 있죠. 지금은 인증을 받지 않은 사용자도 메서드 보안을 클릭하게 되면 현재 해당 지금 methodSecured 여기에 지금 접근이 가능합니다. 가능하죠. 인증을 받지 않아도 그러면 관리자에 가서 다시 리소스 가서 등록을 해보겠습니다. 

메소스 명에 그 정보를 io.security.corespringsecurity.aopsecurity.AopMethodService.methodSecured를 적어주시면 돼요. 그래서 패키지 이름과 클래스 이름 메소드 이름까지 해서 리소스 명으로 적어주고 타입은 리소스 타입은 메소드고요. 

이렇게 해서 현재 이 메소드 안으로 접근하기 위해서는 ROLE_USER 권한을 가진 사용자가 접근이 가능하도록 그렇게 매핑을 해서 설정을 하도록 하겠습니다. 등록을 하게 되면 지금 메소드 보안이 설정이 됐고요. 이 상태에서 제가 다시 메소드 보안을 클릭하게 되면 여기를 왔는데요. 조금 전에는 여기로 진입이 가능했죠. 

가능했는데 제가 다시 이 스위스의 메소드를 호출하도록 하겠습니다. 
그런데 보시면 이렇게 예외가 생기게 되고요. 생기게 되고 그 메소드에 접근이 안 되고 있습니다. 
그래서 인증할 수 있는 인증 페이지로 가죠. 그래서 메소드 보안도 지금 실시간적으로 데이터 베이스 연동해서 인가 체계가 되고 있습니다. 

현재 이 메소드에는 어떠한 권한도 설정이 되지 않죠. 소스 코드에서 우리가 설정을 전혀 하지 않고 있습니다. 
않고 있고 모든 인가 처리 보안 처리는 그 정보를 우리가 저장하고 그 저장된 정보를 거기서 우리가 가지고 와서 스프링 시큐리티가 그 데이터를 가지고 인가 처리를 하고 있는 거죠. 
그래서 지금 메소드 보안이 지금 적용되고 있습니다. 적용되고 있어요. 

그러면 마지막으로 메소드 보안 중에서 포인트컷 보안에 대해서 살펴보도록 하죠.

포인트컷 보안은 이렇게 포인트 컷 표현식을 써서 메서드 위에서 메소드에 보안 세팅을 할 수 있도록 그렇게 처리를 하는 겁니다. 
execution(public * io.security.corespringsecurity.aopsecurity.*Service.pointcut*(..))
그래서 이 포인트 표현식 이 자원을 등록하도록 하겠습니다. 
타입은 포인트컷이고 그리고 ROLE_ADMIN 권한을 가진 사용자가 접근이 가능하도록 그렇게 설정하도록 하겠습니다. 

보시면 해당 패키지의 클래스가 가지고 있는 메소드 중에서 포인트 컷 으로 시작하는 모든 메소드에는 인가 처리가 될 수 있도록 그 인가 처리는 ROLE_ADMIN 권한을 가진 사용자만 접근 가능하도록 그렇게 우리가 설정을 했습니다. 
설정을 한 다음에 등록을 했고요. 등록을 했고 지금은 포인트컷 보안 메뉴에 접근을 하고 그 다음에 지금 포인트컷 서비스 중에서 notSecured()가 있고 pointcutSecured()가 있는데 우리는 지금 포인트 컷으로 시작하는 이 메소드에 지금 보안을 설정했죠. 
근데 현재는 지금 notSecured()은 보안이 설정되지 않아서 접근이 가능하고 pointcutSecured()일때는 표현식에 의해서 현재 보안이 설정이 되어져야 되는데 아직까지는 우리가 초기화 상태 포인트 표현식의 초기화 과정을 거치지 않았기 때문에 지금은 아무런 인증을 받지 않아도 ROLE_ADMIN 권한을 가지지 않아도 지금 접근이 가능하고 있습니다. 

그러면 제가 포인트컷 기능을 활성하고요. 활성하고 다시 서버를 기동해서 스프링이 초기화 될 때 우리가 등록한 포인트 컷 이 표현식을 해석하고 Parsing해서 여기 포인트 컷 이 메소드로 시작하는 그 메소드에는 ROLE_ADMIN 권한을 설정하도록 그렇게 스프링 시큐리티가 초기화하면서 그렇게 처리가 이루어집니다. 

그러면 서버가 가동되었고요. 제가 인증을 받지 않고 인증 없이 다시 포인트컷 보안에 접속을 하게 되면 notSecured()는 포인트컷 표현식에 지금 해당되지 않기 때문에 접근이 가능하고요. 그 다음에 pointcutSecured() 메소드는 ROLE_ADMIN 그 권한에 매핑된 보안이 설정된 메소드입니다. 그래서 접근이 가능하지 않습니다.가능하지 않죠. 

그래서 지금 로그인 페이지로 이동하고 있습니다. 그런데 ADMIN으로 로그인하게 되면 이제는 접근이 가능하겠죠. notSecured()는 아무런 보안이 설정되지 않아서 접근이 가능하고 pointcutSecured()는 표현식에 의해서 보안이 설정되었지만 지금 ADMIN으로 로그인을 했기 때문에 역시 접근이 가능합니다. 

그래서 지금까지 우리가 살펴본 내용은 일단 우리가 인증 처리 시스템을 가지고 있고 각각의 사용자를 등록한 다음에 관리자 시스템에서 그 사용자들에게 각각의 권한들을 설정하게 되고 그 다음에 각 자원에 설정된 그 자원에 접근을 하기 위해서는 해당 자원에 설정된 그 권한을 가진 사용자만 접근이 가능하도록 살펴봤고 그 다음에 ADMIN 권한을 가진 사용자가 Role_Hierarchy(하이라이키) 기능이 활성화되면 그 하위 레벨에 있는 그 권한이 접근할 수 있는 자원에도 접근이 가능한 그 기능도 우리가 확인해 봤고요.

그 다음에 메소드 보안과 포인트 컷 보안을 우리가 직접 관리자 시스템에서 그 자원을 등록했을 때 해당 메소드 서비스 계층의 메소드에 접근이 가능한지 또 접근이 가능하지 않는지 그 처리 과정도 우리가 테스트해봤습니다. 그리고 메소드 보안은 일반적으로 aop 기반으로 동작하고 url 방식의 자원 접근은 필터 기반으로 인가 처리가 이루어집니다. 

그래서 이 모든 내용들은 우리가 이번 강좌를 통해서 인가 처리와 인증 처리, 그 모든 학습을 통해서 다 배우게 될 것이고요.

최종적으로는 이런 결과물을 우리가 만들고 그리고 인가 처리와 인증 처리 모든 시스템이 외부와 연동해서 데이터베이스와 연동해서 처리가 다 이루어지도록
동적인 인증 처리와 동적인 인가 처리가 이루어질 수 있도록 그렇게 우리가 프로젝트를 구성하게 될 것입니다. 

그러면 이번 시간에는 우리가 만들게 될 최종적으로 만들게 될 프로젝트에 대해서 미리 살펴보는 시간을 가졌습니다. 
